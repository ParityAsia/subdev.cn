<!DOCTYPE html>
<html lang="en" data-theme="">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<script type="text/javascript">/*<![CDATA[*/window.__chunkMapping={"main":["/subdev.cn/main.836d044100531021daee.css","/subdev.cn/main.32bd15e7ca21de841852.js"],"component---site-src-pages-index-jsc-4-f-f99":["/subdev.cn/component---site-src-pages-index-jsc-4-f-f99.9f99729bff7f082bd679.css","/subdev.cn/component---site-src-pages-index-jsc-4-f-f99.6ea7f10d27d42f5c20be.js"],"component---theme-blog-post-pageccc-cab":["/subdev.cn/component---theme-blog-post-pageccc-cab.42d18faa279882580cbb.css","/subdev.cn/component---theme-blog-post-pageccc-cab.6108a43cd1ad60b34245.js"],"content---subdev-cn-blog-welcome-286-652":["/subdev.cn/content---subdev-cn-blog-welcome-286-652.927441d1691f983a7761.js"],"metadata---subdev-cn-blog-welcome-518-d57":["/subdev.cn/metadata---subdev-cn-blog-welcome-518-d57.a3f1c47631e8d941019a.js"],"nextItem---subdev-cn-blog-welcome-967-e8e":["/subdev.cn/nextItem---subdev-cn-blog-welcome-967-e8e.68a8e480d65f7d06a6ee.js"],"content---subdev-cn-blog-hello-worldd-61-6f9":["/subdev.cn/content---subdev-cn-blog-hello-worldd-61-6f9.dc48ef30cc8c6cf7bf7b.js"],"nextItem---subdev-cn-blog-hello-worldbf-6-b31":["/subdev.cn/nextItem---subdev-cn-blog-hello-worldbf-6-b31.efb0b246d85709675a4c.js"],"content---subdev-cn-blog-holabdd-b2b":["/subdev.cn/content---subdev-cn-blog-holabdd-b2b.e4eebd99188ff045da21.js"],"component---theme-doc-page-1-be-9be":["/subdev.cn/component---theme-doc-page-1-be-9be.a7dc664af81736e8f518.css","/subdev.cn/component---theme-doc-page-1-be-9be.6d8b707092b19487ef62.js"],"docsMetadata---subdev-cn-docs-057-154":["/subdev.cn/docsMetadata---subdev-cn-docs-057-154.0bb67635aa11ecc72234.js"],"component---theme-doc-item-178-a40":["/subdev.cn/component---theme-doc-item-178-a40.de2648345892298aff25.css","/subdev.cn/component---theme-doc-item-178-a40.d4f0c9c08165c6fd64e8.js"],"content---subdev-cn-docs-doc-1-b-2-f-2f3":["/subdev.cn/content---subdev-cn-docs-doc-1-b-2-f-2f3.4256be68b67451d9e159.js"],"metadata---subdev-cn-docs-doc-1-ca-3-aea":["/subdev.cn/metadata---subdev-cn-docs-doc-1-ca-3-aea.0b1ea171188228a5beb9.js"],"content---subdev-cn-docs-mdxce-3-1a1":["/subdev.cn/content---subdev-cn-docs-mdxce-3-1a1.bcfda9d75852b0e88703.js"],"metadata---subdev-cn-docs-mdx-8-d-6-78c":["/subdev.cn/metadata---subdev-cn-docs-mdx-8-d-6-78c.5758d77751c6153b427f.js"],"content---subdev-cn-docs-how-to-dev-140-ca0":["/subdev.cn/content---subdev-cn-docs-how-to-dev-140-ca0.ab4598625df2f02792a8.js"],"metadata---subdev-cn-docs-how-to-dev-830-aa4":["/subdev.cn/metadata---subdev-cn-docs-how-to-dev-830-aa4.2936faed9c3d3b4721f0.js"],"content---subdev-cn-docs-learn-resource-2-c-1-5be":["/subdev.cn/content---subdev-cn-docs-learn-resource-2-c-1-5be.7476d084a5ecdc3a0db0.js"],"metadata---subdev-cn-docs-learn-resourceec-8-00e":["/subdev.cn/metadata---subdev-cn-docs-learn-resourceec-8-00e.0edb19fb14de6d8928dd.js"],"content---subdev-cn-docs-dappchain-install-5-f-8-78a":["/subdev.cn/content---subdev-cn-docs-dappchain-install-5-f-8-78a.bf6323bfa7cb2d8ad4f1.js"],"metadata---subdev-cn-docs-dappchain-install-86-a-780":["/subdev.cn/metadata---subdev-cn-docs-dappchain-install-86-a-780.f3c5dd5e18f289b9dbed.js"],"content---subdev-cn-docs-dappchain-deploy-parachainf-8-f-801":["/subdev.cn/content---subdev-cn-docs-dappchain-deploy-parachainf-8-f-801.f9987ad5c2db2aeac649.js"],"metadata---subdev-cn-docs-dappchain-deploy-parachain-3-fd-9e3":["/subdev.cn/metadata---subdev-cn-docs-dappchain-deploy-parachain-3-fd-9e3.2bb512ebb4b1092cc9b5.js"],"content---subdev-cn-docs-dappchain-add-ui-5-aa-eda":["/subdev.cn/content---subdev-cn-docs-dappchain-add-ui-5-aa-eda.295ca483601fe7378735.js"],"metadata---subdev-cn-docs-dappchain-add-ui-3-fa-009":["/subdev.cn/metadata---subdev-cn-docs-dappchain-add-ui-3-fa-009.69b98bb2e24b76d5882d.js"],"content---subdev-cn-docs-dappchain-add-test-8-f-2-a27":["/subdev.cn/content---subdev-cn-docs-dappchain-add-test-8-f-2-a27.ce577b1e3ec7e5c00241.js"],"metadata---subdev-cn-docs-dappchain-add-test-9-c-3-a94":["/subdev.cn/metadata---subdev-cn-docs-dappchain-add-test-9-c-3-a94.5010b256688fe47447d2.js"],"content---subdev-cn-docs-dappchain-deploy-standalonea-8-c-c2d":["/subdev.cn/content---subdev-cn-docs-dappchain-deploy-standalonea-8-c-c2d.155c8b28b01189cd293f.js"],"metadata---subdev-cn-docs-dappchain-deploy-standalonedf-5-26c":["/subdev.cn/metadata---subdev-cn-docs-dappchain-deploy-standalonedf-5-26c.db4e5b7d0f904eae906f.js"],"content---subdev-cn-docs-dappchain-setup-local-networkab-6-46b":["/subdev.cn/content---subdev-cn-docs-dappchain-setup-local-networkab-6-46b.769e30f09846a4f141a3.js"],"metadata---subdev-cn-docs-dappchain-setup-local-networke-6-b-cd0":["/subdev.cn/metadata---subdev-cn-docs-dappchain-setup-local-networke-6-b-cd0.8dbf8896c62892e5575a.js"],"content---subdev-cn-docs-dappchain-deploy-parathread-801-b35":["/subdev.cn/content---subdev-cn-docs-dappchain-deploy-parathread-801-b35.1144c25197437d4189ea.js"],"metadata---subdev-cn-docs-dappchain-deploy-parathread-772-b61":["/subdev.cn/metadata---subdev-cn-docs-dappchain-deploy-parathread-772-b61.69e3de462f69e90cf3c9.js"],"content---subdev-cn-docs-dappchain-add-custom-module-97-c-01a":["/subdev.cn/content---subdev-cn-docs-dappchain-add-custom-module-97-c-01a.a8f17af53f5e9dde1c1c.js"],"metadata---subdev-cn-docs-dappchain-add-custom-modulef-81-487":["/subdev.cn/metadata---subdev-cn-docs-dappchain-add-custom-modulef-81-487.0e9694d70da20624a7fc.js"],"component---theme-blog-list-pagea-6-a-7ba":["/subdev.cn/component---theme-blog-list-pagea-6-a-7ba.42d18faa279882580cbb.css","/subdev.cn/component---theme-blog-list-pagea-6-a-7ba.6cf6e7f8a3eb4088c5ac.js"],"content---subdev-cn-blogaf-1-646":["/subdev.cn/content---subdev-cn-blogaf-1-646.6173e55b06d049ce0cd0.js"],"content---subdev-cn-blog-357-d39":["/subdev.cn/content---subdev-cn-blog-357-d39.d5b88c30f772e4c54845.js"],"content---subdev-cn-blog-8-e-9-e36":["/subdev.cn/content---subdev-cn-blog-8-e-9-e36.4b3c1309a83f78613a55.js"],"metadata---subdev-cn-blog-0-a-8-778":["/subdev.cn/metadata---subdev-cn-blog-0-a-8-778.f35b129c93f6e914f9e4.js"],"component---theme-blog-tags-posts-page-687-b6c":["/subdev.cn/component---theme-blog-tags-posts-page-687-b6c.42d18faa279882580cbb.css","/subdev.cn/component---theme-blog-tags-posts-page-687-b6c.483569ca8a19571e10ef.js"],"metadata---subdev-cn-blog-tags-facebook-6-ec-afc":["/subdev.cn/metadata---subdev-cn-blog-tags-facebook-6-ec-afc.3565e594b0f336aa0d40.js"],"metadata---subdev-cn-blog-tags-helloc-12-4ea":["/subdev.cn/metadata---subdev-cn-blog-tags-helloc-12-4ea.b5a2e11348a5e1965c45.js"],"metadata---subdev-cn-blog-tags-docusaurus-9-d-0-a60":["/subdev.cn/metadata---subdev-cn-blog-tags-docusaurus-9-d-0-a60.b7b0923f2755994ab667.js"],"metadata---subdev-cn-blog-tags-holae-0-f-35b":["/subdev.cn/metadata---subdev-cn-blog-tags-holae-0-f-35b.df7a894555c785287c7c.js"],"component---theme-blog-tags-list-page-01-a-d0b":["/subdev.cn/component---theme-blog-tags-list-page-01-a-d0b.85f30dd2cf62990dca68.js"],"tags---subdev-cn-blog-tags-66-c-5a7":["/subdev.cn/tags---subdev-cn-blog-tags-66-c-5a7.02bc572c4533056e2904.js"]};/*]]>*/</script>

<title data-react-helmet="true">开发自定义的功能模块</title>

<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="viewport" content="width=device-width"/><meta data-react-helmet="true" property="og:title" content="Substrate 开发者社区 · 助力区块链开发者"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="description" content="通过本节，你会学到："/><meta data-react-helmet="true" property="og:description" content="通过本节，你会学到："/><meta data-react-helmet="true" property="og:url" content="https://subdev.cn/subdev.cn/docs/dappchain/add_custom_module"/>

<link data-react-helmet="true" rel="shortcut icon" href="/subdev.cn/img/favicon.ico"/>


<link rel="stylesheet" type="text/css" href="/subdev.cn/main.836d044100531021daee.css" />

<link rel="stylesheet" type="text/css" href="/subdev.cn/0.beb5263729d2db16c046.css" />

<link rel="stylesheet" type="text/css" href="/subdev.cn/1.2d0cefca6f8bbc3f601c.css" />

<link rel="stylesheet" type="text/css" href="/subdev.cn/component---theme-doc-page-1-be-9be.a7dc664af81736e8f518.css" />

<link rel="stylesheet" type="text/css" href="/subdev.cn/component---theme-doc-item-178-a40.de2648345892298aff25.css" />

</head>
<body >
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/subdev.cn/"><img class="navbar__logo" src="/subdev.cn/img/logo.svg" alt="My Site Logo"/><strong class="">主页</strong></a><a class="navbar__item navbar__link" label="学习资料" position="left" href="/subdev.cn/docs/learn_resource">学习资料</a><a class="navbar__item navbar__link" to="https://substrater.org" label="论坛" position="left" activeClassName="navbar__link--active" href="https://substrater.org">论坛</a><a class="navbar__item navbar__link" label="博客" position="left" href="/subdev.cn/blog">博客</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="https://github.com/substrater/subdev.cn" label="GitHub" position="right" target="_blank" rel="noopener noreferrer">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_16vC moon_1N64"></span></div><div class="react-toggle-track-x"><span class="toggle_16vC sun_3CZP"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"/></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/subdev.cn/"><img class="navbar__logo" src="/subdev.cn/img/logo.svg" alt="My Site Logo"/><strong>主页</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" label="学习资料" position="left" href="/subdev.cn/docs/learn_resource">学习资料</a></li><li class="menu__list-item"><a class="menu__link" to="https://substrater.org" label="论坛" position="left" activeClassName="navbar__link--active" href="https://substrater.org">论坛</a></li><li class="menu__list-item"><a class="menu__link" label="博客" position="left" href="/subdev.cn/blog">博客</a></li><li class="menu__list-item"><a class="menu__link" href="https://github.com/substrater/subdev.cn" label="GitHub" position="right" target="_blank" rel="noopener noreferrer">GitHub</a></li></ul></div></div></div></nav><main class="main"><div class="docPage_1kjD"><div class="docSidebarContainer_1cYp"><div class="sidebar_1kLs"><div class="menu menu--responsive"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_2vk4" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">如何学习</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/subdev.cn/docs/learn_resource">资料列表</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">区块链应用开发</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/subdev.cn/docs/dappchain/install">安装开发环境</a></li><li class="menu__list-item"><a class="menu__link" href="/subdev.cn/docs/dappchain/setup_local_network">构建开发网络</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/subdev.cn/docs/dappchain/add_custom_module">开发功能模块</a></li><li class="menu__list-item"><a class="menu__link" href="/subdev.cn/docs/dappchain/add_test">添加测试</a></li><li class="menu__list-item"><a class="menu__link" href="/subdev.cn/docs/dappchain/add_ui">添加前端页面</a></li></ul></li></ul></div></div></div><main class="docMainContainer_FFX1"><div><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col"><div class="docItemContainer_2cwg"><header><h1 class="docTitle_1vWb">开发自定义的功能模块</h1></header><article><div class="markdown"><p>通过本节，你会学到：</p><ul><li>如何初始化一个区块链节点</li><li>如何与节点交互</li><li>功能模块的组成</li><li>如何添加新的功能模块</li></ul><h2><a aria-hidden="true" class="anchor" id="预备"></a><a aria-hidden="true" class="hash-link" href="#预备">#</a>预备</h2><ol><li>快速安装Substrate依赖（如已安装，请跳过），详细内容参考开发者中心文档<a href="https://substrate.dev/docs/en/getting-started/installing-substrate#fast-installation">Installing Substrate</a>：</li></ol><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">curl</span><span class="token plain"> https://getsubstrate.io -sSf </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">bash</span><span class="token plain"> -s -- --fast</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><ol start="2"><li>更新<a href="https://github.com/paritytech/substrate-up">substrate-up</a>脚本，它提供了初始化节点、创建新模块等功能：</li></ol><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/paritytech/substrate-up</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> substrate-up</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> -a substrate-* ~/.cargo/bin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> -a polkadot-* ~/.cargo/bin</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h2><a aria-hidden="true" class="anchor" id="创建区块链节点"></a><a aria-hidden="true" class="hash-link" href="#创建区块链节点">#</a>创建区块链节点</h2><p>作为一个通用的区块链开发框架，Substrate提供了用于构建区块链的所有组件，<strong>开发者要做的只是将需要的组件组装起来</strong>。为了帮助开发者从繁杂的组装工作中解放出来，Substrate提供了两类的节点程序来快速实现组装工作：</p><ul><li><a href="https://github.com/paritytech/substrate/tree/v1.0/node-template">Template Node</a>: 包含了所需用到的最少组件，但是依然具备完善的区块链功能。可以在其上快速开发应用，添加新的功能模块。</li><li><a href="https://github.com/paritytech/substrate/tree/v1.0/node">Node</a>: 基本上包含了Substrate提供的所有组件，让你能够测试内置的各种功能。</li></ul><blockquote><p>这里所说的<strong>节点</strong>通常也被称为<strong>点对点节点</strong>或者<strong>全节点</strong>，承载了区块链的所有功能，你可以把它想象成传统互联网开发中的后端，但是没有放在中心化的服务器上，而是散落在世界的各个角落里。</p></blockquote><p>本文我们将会用Template Node作为我们的节点程序，承载我们的抛硬币游戏。</p><h3><a aria-hidden="true" class="anchor" id="初始化节点"></a><a aria-hidden="true" class="hash-link" href="#初始化节点">#</a>初始化节点</h3><p><code>substrate-up</code>脚本提供的初始化节点命令是<code>substrate-node-new</code>，通过下载和编译Template Node来生成我们的节点程序。运行下面的命令来生成节点，替换<code>demo-node</code>为你自己的节点名，替换<code>yourname</code>为你的团队或个人名字：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">substrate-node-new demo-node yourname</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>启动刚刚生成的节点：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> demo-node</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./target/release/demo-node --dev</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>如果在控制台看到这些内容，证明你的节点创建成功：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-undefined codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Substrate Node</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45   version 1.0.0-2857a44-x86_64-macos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45   by demo-author, 2017, 2018</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Chain specification: Development</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Node name: safe-tin-6167</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Roles: AUTHORITY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Initializing Genesis block/state (state: 0x79b0…3c01, header-hash: 0xacb5…bb17)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Loaded block-time = 10 seconds from genesis on first-launch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Best block: #0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Using default protocol ID &quot;sup&quot; because none is configured in the chain specs</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Local node identity is: QmZH4oHKH4nwaP4apeYCM7EJXkxAjv4AqnJt29MrMNhWBV</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:45 Libp2p =&gt; Random Kademlia query has yielded empty results</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:46 Listening for new connections on 127.0.0.1:9944.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:46 Using authority key 5FA9nQDVg267DEd8m1ZypXLBnvN7SFxYwV7ndqSYGiN9TTpu</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:48 Libp2p =&gt; Random Kademlia query has yielded empty results</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:49 Accepted a new tcp connection from 127.0.0.1:62636.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:50 Starting consensus session on top of parent 0xacb55b52944dff23e2aa99326cc20b1f9c091556516d15db9ffcffd7d159bb17</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:50 Prepared block for proposing at 1 [hash: 0x2d84be81477309b475af22c457f850174c498d1b0d19032f18fe7f7656233dad; parent_ha</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sh: 0xacb5…bb17; extrinsics: [0xb1d4…9362]]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:50 Pre-sealed block for proposal at 1. Hash now 0x1d70dc9d4299519880cc5824cee49ffa0c5a74ec5a9bb238012ae5ff65055302, previ</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ously 0x2d84be81477309b475af22c457f850174c498d1b0d19032f18fe7f7656233dad.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:50 Imported #1 (0x1d70…5302)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2019-07-27 18:03:50 Idle (0 peers), best: #1 (0x1d70…5302), finalized #0 (0xacb5…bb17), ⬇ 0 ⬆ 0</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>以上输出的内容包含了一些有价值的信息如：</p><ul><li>Chain specification: <code>Development</code> ，表明我们使用的是内置开发模式的chain spec。</li><li>Node identity: <code>QmZH4oHKH4nwaP4apeYCM7EJXkxAjv4AqnJt29MrMNhWBV</code>, 节点ID。</li><li>Authority key: <code>5FA9nQDVg267DEd8m1ZypXLBnvN7SFxYwV7ndqSYGiN9TTpu</code>, 验证人的公钥。</li><li>WebSocket RPC 的 IP 和端口: <code>127.0.0.1:9944</code>。</li><li>Current block: <code>best: #1 (0x1d70…5302)</code>.</li><li>Current finalized block: <code>finalized #0 (0xacb5…bb17)</code>。一直显示 <code>0</code> 是由于 <strong>Template Node</strong> 并没有引入最终性模块 <a href="https://wiki.polkadot.network/en/latest/polkadot/learn/consensus/#what-is-grandpababe">GRANDPA finality gadget</a>。</li></ul><blockquote><p>Substrate 默认的共识机制是基于BABE和GRANDPA的混合共识，详细信息参考<a href="https://wiki.polkadot.network/en/latest/polkadot/learn/consensus/">Polkadot Consensus</a>。</p></blockquote><p>启动之后，你就拥有了一个由单个节点维护的&quot;区块链&quot;网络。下面我们通过UI与刚创建的节点进行交互。</p><h3><a aria-hidden="true" class="anchor" id="节点交互"></a><a aria-hidden="true" class="hash-link" href="#节点交互">#</a>节点交互</h3><p>Substrate生态里提供了一个UI工具 <a href="https://github.com/polkadot-js/apps">Polkadot/Substrate UI</a> 来帮助开发者与Substrate编写的区块链进行交互。你可以根据项目README的指示在本地运行，或者访问官方host的网页应用，链接为：<a href="https://polkadot.js.org/apps%E3%80%82">https://polkadot.js.org/apps。</a></p><p>在 <strong>Settings</strong>页面，配置<code>remote node</code>为之前所说的WebSocket端口<code>127.0.0.1:9944</code>。保存配置后，会有更多的功能在侧边栏出现，供大家使用。</p><p>转到<code>Extrinsics</code>页：</p><ul><li>使用内置的<code>ALICE</code>用户，</li><li>配置 <strong>submit the following extrinsic</strong> 为 <code>template</code> <code>doSomething(something)</code>, </li><li>配置 <strong>something</strong> 为任意整数,</li><li>点击提交 <strong>Submit Transaction</strong>. 几秒钟之后，你将会看到交易成功的提示信息。</li></ul><p>接着，转到 <strong>Chain state</strong> 页面:</p><ul><li>配置 <strong>selected state query</strong> 为 <code>template</code> <code>something(): Option&lt;u32&gt;</code></li><li>点击➕按钮，你会看到刚刚输进入的数字。</li></ul><p>以上就是我们与节点程序的基本交互操作。如果你还不熟悉UI的其它功能，可以多多练习，有助于后面的操作和理解。</p><h2><a aria-hidden="true" class="anchor" id="添加功能模块"></a><a aria-hidden="true" class="hash-link" href="#添加功能模块">#</a>添加功能模块</h2><p>使用Substrate编写区块链应用，数据存储、可调用函数和事件都被封装在自定义的Runtime模块中。以刚刚创建的节点程序为例，预先定义的template模块，代码位于<code>runtime/src/template.rs</code>, 内容包含：</p><ul><li>数据存储（Storage）: <code>Something get(something): Option&lt;u32&gt;</code></li><li>可调用函数（Callable Function）:<pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn do_something(origin, something: u32) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre></li><li>事件（Event）: <code>SomethingStored(u32, AccountId)</code></li></ul><p>下面我们在编写自定义的功能模块时会逐一对上面的内容进行介绍。</p><h3><a aria-hidden="true" class="anchor" id="创建新模块"></a><a aria-hidden="true" class="hash-link" href="#创建新模块">#</a>创建新模块</h3><p><code>substrate-up</code>提供了命令<code>substrate-module-new</code>来帮助我们创建一个template模块，里面包含了一些基本的依赖引入，以及上面提到的数据存储项、可调用函数、事件等示例代码，其中的一些注释可以很好地帮助初学者理解Substrate runtime模块的构成。在节点程序目录下执行如下命令（替换<code>mymodule</code>为你自己的模块名）：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> runtime/src</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">substrate-module-new mymodule</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>执行完成后，你会看到一个新生成的<code>mymodule.rs</code>文件，这就是你的模块程序文件。为了使用这一模块，我们还需要修改当前目录下的<code>lib.rs</code>：</p><ul><li>引入我们新定义的模块:</li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mod mymodule;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><ul><li>实现模块的配置接口：</li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">impl mymodule::Trait for Runtime {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    type Event = Event;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><ul><li>添加模块到<code>construct_runtime!</code>宏：</li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">construct_runtime!(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub enum Runtime with Log(InternalLog: DigestItem&lt;Hash, AuthorityId, AuthoritySignature&gt;) where</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Block = Block,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        NodeBlock = opaque::Block,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        UncheckedExtrinsic = UncheckedExtrinsic</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        MyModule: mymodule::{Module, Call, Storage, Event&lt;T&gt;},</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><blockquote><p><a href="https://en.wikipedia.org/wiki/Metaprogramming"><strong>宏</strong></a>通常被称为元编程，根据提供的代码可以生成新的代码，实现代码复用。Substrate使用了大量的宏来减轻开发人员的工作，让人&quot;又爱又恨&quot;，更多细节参考 <a href="../runtime/macros/construct_runtime.md"><code>construct_runtime!</code></a>。</p></blockquote><p>接下来，重新编译我们的节点程序：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-bash codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 编译runtime的wasm版本</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./scripts/build.sh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 编译runtime的本地二进制版本，并构建可执行的客户端</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cargo build --release</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 删除链上的历史数据</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./target/release/demo-node purge-chain --dev</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># 启动本地测试网络</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./target/release/demo-node --dev</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>请通过 <a href="https://github.com/polkadot-js/apps">Polkadot/Substrate UI</a> 简单测试一下新创建模块的功能。</p><h3><a aria-hidden="true" class="anchor" id="添加业务功能"></a><a aria-hidden="true" class="hash-link" href="#添加业务功能">#</a>添加业务功能</h3><p>本文，我们实现的业务是&quot;抛硬币&quot;游戏，用户可以付费玩游戏，如果抛出的结果为&quot;正面朝上&quot;，则用户胜利，获取奖池里的奖金；如果用户失败，则什么都拿不到。无论胜负，用户支付的游戏费用都要存进奖池，以备后面的用户使用。</p><h4><a aria-hidden="true" class="anchor" id="添加storage-item"></a><a aria-hidden="true" class="hash-link" href="#添加storage-item">#</a>添加Storage Item</h4><p>Runtime开发的第一步是设计你的存储数据结构，比如这里需要的游戏花费和奖池，在模块的<code>decl_storage!</code>宏中添加如下存储项：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">decl_storage! {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    trait Store for Module&lt;T: Trait&gt; as mymodule {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Payment get(payment): Option&lt;T::Balance&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Pot get(pot): T::Balance;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Nonce get(nonce): u64;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><blockquote><p>这里我们使用的<code>decl_storage!</code>宏使代码变得简单易懂，由Substrate负责生成更多和数据库进行交互的辅助代码，开发者只需设计存储的数据模型。</p></blockquote><p>这里有三个存储项：</p><ul><li><p><code>Payment</code> 类型为 <code>Option&lt;T::Balance&gt;</code> ，保存着游戏的花费。使用<code>Option</code>表明该费用是否已经被初始化。</p></li><li><p><code>Pot</code> 类型为 <code>T::Balance</code> ，保存了上次获胜者之后累积的所有奖励。</p></li><li><p><code>Nonce</code> 为<code>u64</code>类型的整数，我们将会在生成随机数的时候用到。</p><p><code>Balance</code> 类型是由 <a href="https://substrate.dev/rustdocs/v1.0/srml_balances/index.html">SRML balances</a> 模块提供的，用来表示账户的余额。要使用它，需要将我们模块的配置接口修改为依赖 <a href="https://substrate.dev/rustdocs/v1.0/srml_balances/trait.Trait.html">balances Trait</a>:</p></li></ul><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub trait Trait: balances::Trait {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>代码中<code>get(payment)</code>是用来定义<code>Payment</code>存储项的另一种getter函数，下面的章节我们再介绍如何使用这些getter函数。</p><h4><a aria-hidden="true" class="anchor" id="定义callable-function"></a><a aria-hidden="true" class="hash-link" href="#定义callable-function">#</a>定义Callable Function</h4><p>本节我们将会定义Runtime开发所需的可调用函数。这里所说的可调用函数，是那些可以被用户调用，并且与区块链系统进行交互的函数。函数本身是不可以被代码之外进行调用的，但是由于Substrate的封装开放了对应的RPC接口，更多细节这里我们不过多的讨论。我们为&quot;抛硬币&quot;游戏定义了两个函数：一个用来初始化游戏花费；另一个用来开始游戏并生成游戏结果。</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">decl_module! {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub struct Module&lt;T: Trait&gt; for enum Call where origin: T::Origin {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        fn set_payment(_origin, value: T::Balance) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Logic for setting the game payment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        play(origin) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            // Logic for playing the game</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>上面的代码显示了我们的可调用函数位于<code>Module</code>结构体中，下面我们将会为函数添加真正的逻辑。对于 <code>set_payment</code> 函数:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This function initializes the `payment` storage item</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// It also populates the pot with an initial value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn set_payment(origin, value: T::Balance) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Ensure that the function call is a signed message (i.e. a transaction)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let _ = ensure_signed(origin)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // If `payment` is not initialized with some value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if Self::payment().is_none() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Set the value of `payment`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Payment&lt;T&gt;&gt;::put(value);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Initialize the `pot` with the same value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Pot&lt;T&gt;&gt;::put(value);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Return Ok(()) when everything happens successfully</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>我们的 <code>set_payment</code> 函数需要两个参数，</p><ul><li><code>origin</code>， 类型为 <a href="https://substrate.dev/rustdocs/v1.0/srml_system/type.Origin.html">SRML system</a> 模块定义的<code>T::Origin</code>，包含了函数调用的发出方。这个参数总是作为可调用函数的第一个参数。Substrate允许我们为这个参数缺省类型签名来简化工作。参考这里<a href="../overview/glossary.md#origin">Origin的定义</a>。</li><li><code>value</code> ，类型为 <code>T::Balance</code>，用来初始化 <code>Payment</code> 和<code>Pot</code>。</li></ul><p>接下来，我们来实现 <code>play</code> 函数：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This function is allows a user to play our coin-flip game</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn play(origin) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Ensure that the function call is a signed message (i.e. a transaction)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Additionally, derive the sender address from the signed message</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let sender = ensure_signed(origin)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Ensure that `payment` storage item has been set</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let payment = Self::payment().ok_or(&quot;Must have payment amount set&quot;)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Read our storage values, and place them in memory variables</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut nonce = Self::nonce();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut pot = Self::pot();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Try to withdraw the payment from the account, making sure that it will not kill the account</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let _ = &lt;balances::Module&lt;T&gt; as Currency&lt;_&gt;&gt;::withdraw(&amp;sender, payment, WithdrawReason::Reserve, ExistenceRequirement::KeepAlive)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Generate a random hash between 0-255 using a csRNG algorithm</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (&lt;system::Module&lt;T&gt;&gt;::random_seed(), &amp;sender, nonce)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .using_encoded(&lt;T as system::Trait&gt;::Hashing::hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .using_encoded(|e| e[0] &lt; 128)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // If the user won the coin flip, deposit the pot winnings; cannot fail</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        let _ = &lt;balances::Module&lt;T&gt; as Currency&lt;_&gt;&gt;::deposit_into_existing(&amp;sender, pot)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          .expect(&quot;`sender` must exist since a transaction is being made and withdraw will keep alive; qed.&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Reduce the pot to zero</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pot = Zero::zero();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // No matter the outcome, increase the pot by the payment amount</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pot = pot.saturating_add(payment);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Increment the nonce</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nonce = nonce.wrapping_add(1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Store the updated values for our module</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Pot&lt;T&gt;&gt;::put(pot);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &lt;Nonce&lt;T&gt;&gt;::put(nonce);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Return Ok(()) when everything happens successfully</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>上面的 <code>play</code> 函数只接收 <code>orgin</code> 这一个参数。然后做一些预置条件检查如，交易应当被签名，并且<code>payment</code>存储项不能为空。这里我们使用了 <code>Self::payment()</code> 来获取存储项中的具体值，这就是我们上面说到的getter函数的具体使用方法，另一种获取存储项的方法为 <code>&lt;Payment&lt;T&gt;&gt;::get()</code>。</p><p>在真正&quot;抛硬币&quot;之前，我们需要将游戏所需的花费从用户账户取出，当游戏结束之后将这些费用放入奖池中。代码中使用的 <code>withdraw</code> 函数还需要引入下面的依赖:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use support::traits::{Currency, WithdrawReason, ExistenceRequirement};</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>当硬币被抛出之后，用户有百分之五十的几率获胜。为了模拟这样的情况，首先生成一个0到255的随机数，再拿这个随机数跟128进行比较，如果小于128，那么用户获胜并获得奖池中的奖金；反之失败，用户什么都没有得到。最后更新存储项，为下一次游戏做准备。关于更多的随机数生成，请参考 <a href="https://substrate.dev/substrate-collectables-workshop/#/2/generating-random-data">Generating Random Data</a> 页面</p><p>最后还需要引入的依赖有:</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use runtime_primitives::traits::{Zero, Hash, Saturating};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use parity_codec::Encode;</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><h4><a aria-hidden="true" class="anchor" id="生成event"></a><a aria-hidden="true" class="hash-link" href="#生成event">#</a>生成Event</h4><p>客户端通过监听区块中的Event来更新链下的存储状态或与用户交互。</p><p>当Payment被更新之后我们希望产生一个包含Payment信息的Event，由于用到了<code>Balance</code>类型，我们需要修改Event enum，添加泛型约束<code>Balance = &lt;T as balances::Trait&gt;::Balance</code>：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">decl_event!(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub enum Event&lt;T&gt; where</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        AccountId = &lt;T as system::Trait&gt;::AccountId,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Balance = &lt;T as balances::Trait&gt;::Balance {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>之后，在Event enum中定义我们的Event，并修改<code>set_payment</code>函数来生成这一事件：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">PaymentSet(Balance),</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn set_payment(origin, value: T::Balance) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if Self::payment().is_none() {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        Self::deposit_event(RawEvent::PaymentSet(value));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>当用户完成游戏之后，我们希望产生一个包含用户信息以及获胜信息的事件，同样我们需要添加我们的Event到Event enum中，并在合适的时机触发事件：</p><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">PlayResult(AccountId, Balance),</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><pre class="mdxCodeBlock_iHAB"><div class="codeBlockWrapper_2QGZ"><pre class="prism-code language-rust codeBlock_19pQ" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This function is allows a user to play our coin-flip game</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fn play(origin) -&gt; Result {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let sender = ensure_signed(origin)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut winnings = Zero::zero();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (&lt;system::Module&lt;T&gt;&gt;::random_seed(), &amp;sender, nonce)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .using_encoded(&lt;T as system::Trait&gt;::Hashing::hash)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .using_encoded(|e| e[0] &lt; 128)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Set the winnings</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        winnings = pot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // Reduce the pot to zero</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        pot = Zero::zero();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // --snip--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Raise event for the play result</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Self::deposit_event(RawEvent::PlayResult(sender, winnings));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // Return Ok(()) when everything happens successfully</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button></div></pre><p>这里我们定义了新的变量<code>winnings</code>保存获胜信息，初始值为<code>0</code>，如果获胜则更新为<code>pot</code>即奖池中的值。在函数返回<code>Ok(())</code>之前触发该事件。</p><h2><a aria-hidden="true" class="anchor" id="总结"></a><a aria-hidden="true" class="hash-link" href="#总结">#</a>总结</h2><p>现在已经完成了所有的代码，可以进行简单的测试。同样地，访问 <a href="https://github.com/polkadot-js/apps">Polkadot/Substrate UI</a> 在Extrinsics页面中调用上面定义的函数；之后在Chain state页面查询对应的存储项。遇到问题可以参考这里的 <a href="https://github.com/shawntabrizi/substrate-package/blob/gav-demo/substrate-node-template/runtime/src/demo.rs">“抛硬币”完整代码</a>。</p><h2><a aria-hidden="true" class="anchor" id="reference"></a><a aria-hidden="true" class="hash-link" href="#reference">#</a>Reference</h2><ul><li><a href="https://substrate.dev/docs/en/getting-started/using-the-substrate-scripts">Using the Substrate Scripts</a></li><li><a href="https://substrate.dev/docs/en/tutorials/creating-your-first-substrate-chain">Creating Your First Substrate chain</a></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/subdev.cn/docs/dappchain/setup_local_network"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« <!-- -->构建开发网络</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/subdev.cn/docs/dappchain/add_test"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">添加测试<!-- --> »</h4></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#预备" class="contents__link">预备</a></li><li><a href="#创建区块链节点" class="contents__link">创建区块链节点</a><ul class=""><li><a href="#初始化节点" class="contents__link">初始化节点</a></li><li><a href="#节点交互" class="contents__link">节点交互</a></li></ul></li><li><a href="#添加功能模块" class="contents__link">添加功能模块</a><ul class=""><li><a href="#创建新模块" class="contents__link">创建新模块</a></li><li><a href="#添加业务功能" class="contents__link">添加业务功能</a></li></ul></li><li><a href="#总结" class="contents__link">总结</a></li><li><a href="#reference" class="contents__link">Reference</a></li></ul></div></div></div></div></div></div></main></div></main><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" label="Docs" href="/subdev.cn/docs/doc1">Docs</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" label="Discord" href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Social</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" label="Blog" href="/subdev.cn/blog">Blog</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><img class="footer__logo" alt="Facebook Open Source Logo" src="https://docusaurus.io/img/oss_logo.png"/></div>Copyright © 2019 SubDev</div></div></footer>
</div>

<script type="text/javascript" src="/subdev.cn/runtime~main.8c69e4f82d1fcb7872cb.js"></script>

<script type="text/javascript" src="/subdev.cn/main.32bd15e7ca21de841852.js"></script>

<script type="text/javascript" src="/subdev.cn/0.f4430d4264618b5b7084.js"></script>

<script type="text/javascript" src="/subdev.cn/1.e6b3bb556b317662fc22.js"></script>

<script type="text/javascript" src="/subdev.cn/component---theme-doc-page-1-be-9be.6d8b707092b19487ef62.js"></script>

<script type="text/javascript" src="/subdev.cn/docsMetadata---subdev-cn-docs-057-154.0bb67635aa11ecc72234.js"></script>

<script type="text/javascript" src="/subdev.cn/component---theme-doc-item-178-a40.d4f0c9c08165c6fd64e8.js"></script>

<script type="text/javascript" src="/subdev.cn/content---subdev-cn-docs-dappchain-add-custom-module-97-c-01a.a8f17af53f5e9dde1c1c.js"></script>

<script type="text/javascript" src="/subdev.cn/metadata---subdev-cn-docs-dappchain-add-custom-modulef-81-487.0e9694d70da20624a7fc.js"></script>

</body>
</html>